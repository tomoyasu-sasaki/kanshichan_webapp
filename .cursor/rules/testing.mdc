---
description: 
globs: 
alwaysApply: false
---
# ğŸ§ª KanshiChan ãƒ†ã‚¹ãƒˆå°‚ç”¨ãƒ«ãƒ¼ãƒ«

## ğŸ“‹ ã“ã®ãƒ«ãƒ¼ãƒ«ã®ç›®çš„
KanshiChanï¼ˆç›£è¦–ã¡ã‚ƒã‚“ï¼‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹ãƒ†ã‚¹ãƒˆä½œæˆãƒ»å®Ÿè¡Œã‚’åŠ¹ç‡çš„ã‹ã¤å“è³ªé«˜ãå®Ÿè¡Œã™ã‚‹ãŸã‚ã®å°‚ç”¨ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚

## ğŸ¯ ãƒ†ã‚¹ãƒˆæ–¹é‡

### ğŸ“Œ å¿…é ˆç¢ºèªäº‹é …
ãƒ†ã‚¹ãƒˆä½œæˆé–‹å§‹å‰ã«ä»¥ä¸‹ã®è¦ç´„ã‚’å¿…ãšå‚ç…§ã—ã¦ãã ã•ã„ï¼š
- **[project_rules/main_rules.yaml](mdc:project_rules/main_rules.yaml)** - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“è¦ç´„
- **[project_rules/backend_rules.yaml](mdc:project_rules/backend_rules.yaml)** - Python/Flask è¦ç´„
- **[project_rules/frontend_rules.yaml](mdc:project_rules/frontend_rules.yaml)** - React/TypeScript è¦ç´„
- **[project_rules/ai_ml_rules.yaml](mdc:project_rules/ai_ml_rules.yaml)** - AI/ML è¦ç´„

### ğŸ¯ ãƒ†ã‚¹ãƒˆå“è³ªç›®æ¨™
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: 80%ä»¥ä¸Šï¼ˆãƒ©ã‚¤ãƒ³ãƒ»ãƒ–ãƒ©ãƒ³ãƒãƒ»é–¢æ•°ï¼‰
- **å®Ÿè¡Œæ™‚é–“**: å˜ä½“ãƒ†ã‚¹ãƒˆ <5ç§’ã€çµåˆãƒ†ã‚¹ãƒˆ <30ç§’
- **ä¿¡é ¼æ€§**: Flaky test 0%
- **ä¿å®ˆæ€§**: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚è¦ç´„æº–æ‹ 

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ğŸ”º ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰
```
        /\
       /E2E\     <- å°‘æ•°ï¼ˆé‡è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ï¼‰
      /____\
     /      \
    /Integration\ <- ä¸­ç¨‹åº¦ï¼ˆAPIãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé€£æºï¼‰
   /__________\
  /            \
 /   Unit Tests  \ <- å¤šæ•°ï¼ˆå€‹åˆ¥æ©Ÿèƒ½ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
/________________\
```

#### å˜ä½“ãƒ†ã‚¹ãƒˆ (70%)
- **Backend**: å€‹åˆ¥é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ
- **Frontend**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»Hookãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒ†ã‚¹ãƒˆ
- **AI/ML**: æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒ»ç”»åƒå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ

#### çµåˆãƒ†ã‚¹ãƒˆ (20%)
- **Backend**: API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
- **Frontend**: è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé€£æºã®ãƒ†ã‚¹ãƒˆ
- **AI/ML**: ãƒ¢ãƒ‡ãƒ«çµ±åˆãƒ»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆ

#### E2Eãƒ†ã‚¹ãƒˆ (10%)
- **é‡è¦ãƒ•ãƒ­ãƒ¼**: ç›£è¦–é–‹å§‹ã€œæ¤œå‡ºã€œé€šçŸ¥ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼
- **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£**: ä¸»è¦ãªæ“ä½œã‚·ãƒŠãƒªã‚ª

---

## ğŸ Backend ãƒ†ã‚¹ãƒˆ (Python/pytest)

### ğŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```
backend/tests/
â”œâ”€â”€ unit/                    # å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ test_detector.py
â”‚   â”‚   â””â”€â”€ test_monitor.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ test_detection_service.py
â”‚   â”‚   â””â”€â”€ test_notification_service.py
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ test_image_utils.py
â”‚   â””â”€â”€ web/
â”‚       â””â”€â”€ test_api.py
â”œâ”€â”€ integration/             # çµåˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_api_endpoints.py
â”‚   â””â”€â”€ test_detection_pipeline.py
â”œâ”€â”€ e2e/                     # E2Eãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ test_full_workflow.py
â”œâ”€â”€ fixtures/                # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ images/
â”‚   â””â”€â”€ configs/
â””â”€â”€ conftest.py             # pytestè¨­å®š
```

### ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

#### ã‚¯ãƒ©ã‚¹ãƒ†ã‚¹ãƒˆä¾‹
```python
# backend/tests/unit/core/test_detector.py
import pytest
import numpy as np
from unittest.mock import Mock, patch, MagicMock
from src.core.detector import Detector, DetectionError


class TestDetector:
    """ç‰©ä½“æ¤œå‡ºå™¨ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    @pytest.fixture
    def mock_config(self):
        """è¨­å®šã®ãƒ¢ãƒƒã‚¯ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        config = Mock()
        config.yolo_model_path = "yolov8n.pt"
        config.confidence_threshold = 0.5
        config.nms_threshold = 0.4
        return config
    
    @pytest.fixture
    def detector(self, mock_config):
        """æ¤œå‡ºå™¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        with patch('src.core.detector.YOLO') as mock_yolo:
            mock_model = Mock()
            mock_yolo.return_value = mock_model
            detector = Detector(mock_config)
            detector.model = mock_model
            return detector
    
    @pytest.fixture
    def sample_frame(self):
        """ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        return np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
    
    def test_init_loads_model_successfully(self, mock_config):
        """åˆæœŸåŒ–æ™‚ã«ãƒ¢ãƒ‡ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ"""
        with patch('src.core.detector.YOLO') as mock_yolo:
            detector = Detector(mock_config)
            
            mock_yolo.assert_called_once_with(mock_config.yolo_model_path)
            assert detector.config == mock_config
    
    def test_detect_objects_with_valid_frame(self, detector, sample_frame):
        """æœ‰åŠ¹ãªãƒ•ãƒ¬ãƒ¼ãƒ ã§ç‰©ä½“æ¤œå‡ºãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        mock_results = Mock()
        mock_results.boxes.xyxy = [[100, 100, 200, 200]]
        mock_results.boxes.conf = [0.8]
        mock_results.boxes.cls = [0]  # person class
        detector.model.predict.return_value = [mock_results]
        
        # Act
        result = detector.detect_objects(sample_frame)
        
        # Assert
        assert 'person_detected' in result
        assert result['person_detected'] is True
        assert 'bounding_boxes' in result
        assert len(result['bounding_boxes']) == 1
        detector.model.predict.assert_called_once_with(sample_frame)
    
    def test_detect_objects_with_invalid_frame(self, detector):
        """ç„¡åŠ¹ãªãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        invalid_frame = None
        
        # Act & Assert
        with pytest.raises(ValueError, match="Invalid frame"):
            detector.detect_objects(invalid_frame)
    
    def test_detect_objects_model_prediction_failure(self, detector, sample_frame):
        """ãƒ¢ãƒ‡ãƒ«äºˆæ¸¬å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        detector.model.predict.side_effect = Exception("Model prediction failed")
        
        # Act & Assert
        with pytest.raises(DetectionError, match="Detection processing failed"):
            detector.detect_objects(sample_frame)
    
    @pytest.mark.parametrize("confidence,expected", [
        (0.3, False),  # é–¾å€¤ä»¥ä¸‹
        (0.5, True),   # é–¾å€¤ã¡ã‚‡ã†ã©
        (0.8, True),   # é–¾å€¤ä»¥ä¸Š
    ])
    def test_confidence_threshold_filtering(self, detector, sample_frame, confidence, expected):
        """ä¿¡é ¼åº¦é–¾å€¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        mock_results = Mock()
        mock_results.boxes.xyxy = [[100, 100, 200, 200]]
        mock_results.boxes.conf = [confidence]
        mock_results.boxes.cls = [0]
        detector.model.predict.return_value = [mock_results]
        
        # Act
        result = detector.detect_objects(sample_frame)
        
        # Assert
        assert result['person_detected'] == expected

    def test_performance_benchmark(self, detector, sample_frame):
        """æ¤œå‡ºå‡¦ç†ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ"""
        import time
        
        # Arrange
        mock_results = Mock()
        mock_results.boxes.xyxy = []
        mock_results.boxes.conf = []
        mock_results.boxes.cls = []
        detector.model.predict.return_value = [mock_results]
        
        # Act
        start_time = time.time()
        detector.detect_objects(sample_frame)
        end_time = time.time()
        
        # Assert - æ¤œå‡ºå‡¦ç†ã¯100msä»¥å†…ã§å®Œäº†ã™ã‚‹ã“ã¨
        assert (end_time - start_time) < 0.1
```

#### API ãƒ†ã‚¹ãƒˆä¾‹
```python
# backend/tests/integration/test_api_endpoints.py
import pytest
import json
from src.web.app import create_app


class TestDetectionAPI:
    """æ¤œå‡ºAPI ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    @pytest.fixture
    def app(self):
        """Flaskã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        app = create_app(testing=True)
        app.config['TESTING'] = True
        return app
    
    @pytest.fixture
    def client(self, app):
        """ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        return app.test_client()
    
    def test_start_detection_success(self, client):
        """æ¤œå‡ºé–‹å§‹APIã®æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ"""
        # Act
        response = client.post('/api/detection/start')
        
        # Assert
        assert response.status_code == 200
        data = json.loads(response.data)
        assert data['status'] == 'started'
        assert 'detection_id' in data
    
    def test_get_detection_status(self, client):
        """æ¤œå‡ºçŠ¶æ…‹å–å¾—APIã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange - ã¾ãšæ¤œå‡ºã‚’é–‹å§‹
        start_response = client.post('/api/detection/start')
        detection_id = json.loads(start_response.data)['detection_id']
        
        # Act
        response = client.get(f'/api/detection/status/{detection_id}')
        
        # Assert
        assert response.status_code == 200
        data = json.loads(response.data)
        assert 'person_detected' in data
        assert 'smartphone_detected' in data
    
    def test_api_error_handling(self, client):
        """API ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ"""
        # Act - å­˜åœ¨ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹
        response = client.get('/api/detection/status/invalid_id')
        
        # Assert
        assert response.status_code == 404
        data = json.loads(response.data)
        assert 'error' in data
```

### ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
```bash
# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/ --cov=src --cov-report=html --cov-report=term

# ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
pytest tests/ --cov=src --cov-fail-under=80
```

---

## âš›ï¸ Frontend ãƒ†ã‚¹ãƒˆ (React/Jest/Testing Library)

### ğŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```
frontend/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ MonitorView/
â”‚   â”‚   â”œâ”€â”€ MonitorView.tsx
â”‚   â”‚   â”œâ”€â”€ MonitorView.test.tsx    # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ MonitorView.stories.tsx # Storybook
â”‚   â””â”€â”€ StatusPanel/
â”‚       â”œâ”€â”€ StatusPanel.tsx
â”‚       â””â”€â”€ StatusPanel.test.tsx
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useDetection.ts
â”‚   â””â”€â”€ useDetection.test.ts        # Hookãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ api.ts
â”‚   â””â”€â”€ api.test.ts                 # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
â””â”€â”€ __tests__/                      # E2Eãƒ†ã‚¹ãƒˆ
    â””â”€â”€ detection-flow.test.tsx
```

### ğŸ§ª ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

#### React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆä¾‹
```typescript
// frontend/src/components/MonitorView/MonitorView.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { ChakraProvider } from '@chakra-ui/react';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import { MonitorView } from './MonitorView';
import * as api from '../../utils/api';

// APIã®ãƒ¢ãƒƒã‚¯
vi.mock('../../utils/api');
const mockApi = vi.mocked(api);

// Chakra UI ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
const renderWithChakra = (component: React.ReactElement) => {
  return render(
    <ChakraProvider>
      {component}
    </ChakraProvider>
  );
};

describe('MonitorView', () => {
  const defaultProps = {
    isFullscreen: false,
    onToggleFullscreen: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should render monitoring interface correctly', () => {
    // Arrange & Act
    renderWithChakra(<MonitorView {...defaultProps} />);

    // Assert
    expect(screen.getByText('ç›£è¦–ç”»é¢')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³/i })).toBeInTheDocument();
  });

  it('should start detection when start button is clicked', async () => {
    // Arrange
    mockApi.startDetection.mockResolvedValue({ 
      status: 'started', 
      detection_id: 'test-id' 
    });
    
    renderWithChakra(<MonitorView {...defaultProps} />);
    const startButton = screen.getByRole('button', { name: /é–‹å§‹/i });

    // Act
    fireEvent.click(startButton);

    // Assert
    await waitFor(() => {
      expect(mockApi.startDetection).toHaveBeenCalledTimes(1);
    });
    
    expect(screen.getByText('æ¤œå‡ºä¸­...')).toBeInTheDocument();
  });

  it('should toggle fullscreen when button is clicked', () => {
    // Arrange
    const mockToggle = vi.fn();
    renderWithChakra(
      <MonitorView {...defaultProps} onToggleFullscreen={mockToggle} />
    );
    
    const fullscreenButton = screen.getByRole('button', { name: /ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³/i });

    // Act
    fireEvent.click(fullscreenButton);

    // Assert
    expect(mockToggle).toHaveBeenCalledTimes(1);
  });

  it('should handle detection errors gracefully', async () => {
    // Arrange
    mockApi.startDetection.mockRejectedValue(new Error('API Error'));
    renderWithChakra(<MonitorView {...defaultProps} />);
    
    const startButton = screen.getByRole('button', { name: /é–‹å§‹/i });

    // Act
    fireEvent.click(startButton);

    // Assert
    await waitFor(() => {
      expect(screen.getByText('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).toBeInTheDocument();
    });
  });

  it('should update status when detection results are received', async () => {
    // Arrange
    mockApi.startDetection.mockResolvedValue({ 
      status: 'started', 
      detection_id: 'test-id' 
    });
    mockApi.getDetectionStatus.mockResolvedValue({
      person_detected: true,
      smartphone_detected: true,
      absence_time: 5,
      smartphone_use_time: 10
    });

    renderWithChakra(<MonitorView {...defaultProps} />);
    
    // Act
    fireEvent.click(screen.getByRole('button', { name: /é–‹å§‹/i }));

    // Assert
    await waitFor(() => {
      expect(screen.getByText('äººç‰©æ¤œå‡º: ã‚ã‚Š')).toBeInTheDocument();
      expect(screen.getByText('ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³æ¤œå‡º: ã‚ã‚Š')).toBeInTheDocument();
    });
  });

  it('should be accessible with keyboard navigation', () => {
    // Arrange
    renderWithChakra(<MonitorView {...defaultProps} />);
    const startButton = screen.getByRole('button', { name: /é–‹å§‹/i });

    // Act - Tab ã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•
    startButton.focus();

    // Assert
    expect(startButton).toHaveFocus();
    expect(startButton).toHaveAttribute('aria-label');
  });
});
```

#### Custom Hook ãƒ†ã‚¹ãƒˆä¾‹
```typescript
// frontend/src/hooks/useDetection.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import { useDetection } from './useDetection';
import * as api from '../utils/api';

vi.mock('../utils/api');
const mockApi = vi.mocked(api);

describe('useDetection', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should initialize with default state', () => {
    // Act
    const { result } = renderHook(() => useDetection());

    // Assert
    expect(result.current.isDetecting).toBe(false);
    expect(result.current.status).toEqual({
      personDetected: false,
      smartphoneDetected: false,
      absenceTime: 0,
      smartphoneUseTime: 0
    });
  });

  it('should start detection successfully', async () => {
    // Arrange
    mockApi.startDetection.mockResolvedValue({
      status: 'started',
      detection_id: 'test-id'
    });

    const { result } = renderHook(() => useDetection());

    // Act
    result.current.startDetection();

    // Assert
    await waitFor(() => {
      expect(result.current.isDetecting).toBe(true);
    });
    
    expect(mockApi.startDetection).toHaveBeenCalledTimes(1);
  });

  it('should handle detection errors', async () => {
    // Arrange
    mockApi.startDetection.mockRejectedValue(new Error('API Error'));
    const { result } = renderHook(() => useDetection());

    // Act
    result.current.startDetection();

    // Assert
    await waitFor(() => {
      expect(result.current.error).toBe('æ¤œå‡ºã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
    
    expect(result.current.isDetecting).toBe(false);
  });
});
```

### ğŸ“Š Frontend ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆ
npm run test:coverage

# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:e2e

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
npm run test:watch
```

---

## ğŸ¤– AI/ML ãƒ†ã‚¹ãƒˆ

### ğŸ§ª AI/ML ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

#### ç‰©ä½“æ¤œå‡ºãƒ†ã‚¹ãƒˆä¾‹
```python
# backend/tests/unit/core/test_yolo_detection.py
import pytest
import numpy as np
import cv2
from unittest.mock import Mock, patch
from src.core.yolo_detector import YOLODetector


class TestYOLODetector:
    """YOLOæ¤œå‡ºå™¨ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    @pytest.fixture
    def test_image(self):
        """ãƒ†ã‚¹ãƒˆç”¨ç”»åƒã®ç”Ÿæˆ"""
        # äººå‹ã®ã‚ˆã†ãªå½¢çŠ¶ã‚’æç”»
        image = np.zeros((480, 640, 3), dtype=np.uint8)
        cv2.rectangle(image, (200, 100), (300, 400), (255, 255, 255), -1)  # äººå‹
        cv2.rectangle(image, (350, 200), (380, 230), (255, 255, 255), -1)  # ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‹
        return image
    
    @pytest.fixture
    def detector(self):
        """æ¤œå‡ºå™¨ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        with patch('ultralytics.YOLO') as mock_yolo:
            detector = YOLODetector(model_path="yolov8n.pt")
            return detector
    
    def test_person_detection_accuracy(self, detector, test_image):
        """äººç‰©æ¤œå‡ºç²¾åº¦ã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        mock_results = Mock()
        mock_results.boxes.xyxy = np.array([[200, 100, 300, 400]])  # äººã®å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹
        mock_results.boxes.conf = np.array([0.85])
        mock_results.boxes.cls = np.array([0])  # person class
        detector.model.predict.return_value = [mock_results]
        
        # Act
        results = detector.detect_objects(test_image)
        
        # Assert
        assert results['person_detected'] is True
        assert results['confidence'] >= 0.8  # é«˜ã„ä¿¡é ¼åº¦
        assert len(results['bounding_boxes']) == 1
    
    def test_smartphone_detection_accuracy(self, detector, test_image):
        """ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³æ¤œå‡ºç²¾åº¦ã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        mock_results = Mock()
        mock_results.boxes.xyxy = np.array([[350, 200, 380, 230]])  # ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹
        mock_results.boxes.conf = np.array([0.75])
        mock_results.boxes.cls = np.array([67])  # cell phone class
        detector.model.predict.return_value = [mock_results]
        
        # Act
        results = detector.detect_objects(test_image)
        
        # Assert
        assert results['smartphone_detected'] is True
        assert results['smartphone_confidence'] >= 0.7
    
    def test_fps_performance(self, detector):
        """FPS ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ"""
        import time
        
        # Arrange
        frames = [np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8) for _ in range(30)]
        mock_results = Mock()
        mock_results.boxes.xyxy = np.array([])
        mock_results.boxes.conf = np.array([])
        mock_results.boxes.cls = np.array([])
        detector.model.predict.return_value = [mock_results]
        
        # Act
        start_time = time.time()
        for frame in frames:
            detector.detect_objects(frame)
        end_time = time.time()
        
        # Assert
        total_time = end_time - start_time
        fps = len(frames) / total_time
        assert fps >= 15  # 15 FPSä»¥ä¸Šã§ã‚ã‚‹ã“ã¨
    
    @pytest.mark.parametrize("image_size,expected_processing_time", [
        ((240, 320, 3), 0.03),   # å°ã•ã„ç”»åƒ
        ((480, 640, 3), 0.05),   # æ¨™æº–ç”»åƒ
        ((720, 1280, 3), 0.08),  # å¤§ãã„ç”»åƒ
    ])
    def test_processing_time_by_image_size(self, detector, image_size, expected_processing_time):
        """ç”»åƒã‚µã‚¤ã‚ºåˆ¥å‡¦ç†æ™‚é–“ãƒ†ã‚¹ãƒˆ"""
        import time
        
        # Arrange
        test_image = np.random.randint(0, 255, image_size, dtype=np.uint8)
        mock_results = Mock()
        mock_results.boxes.xyxy = np.array([])
        mock_results.boxes.conf = np.array([])
        mock_results.boxes.cls = np.array([])
        detector.model.predict.return_value = [mock_results]
        
        # Act
        start_time = time.time()
        detector.detect_objects(test_image)
        end_time = time.time()
        
        # Assert
        processing_time = end_time - start_time
        assert processing_time <= expected_processing_time
```

#### MediaPipe ãƒ†ã‚¹ãƒˆä¾‹
```python
# backend/tests/unit/core/test_mediapipe_detector.py
import pytest
import numpy as np
from unittest.mock import Mock, patch
from src.core.mediapipe_detector import MediaPipeDetector


class TestMediaPipeDetector:
    """MediaPipeæ¤œå‡ºå™¨ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    @pytest.fixture
    def detector(self):
        """MediaPipeæ¤œå‡ºå™¨ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        with patch('mediapipe.solutions.pose.Pose') as mock_pose:
            detector = MediaPipeDetector()
            detector.pose = mock_pose.return_value
            return detector
    
    @pytest.fixture
    def person_image(self):
        """äººç‰©ç”»åƒã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£"""
        # äººç‰©ãŒå†™ã£ãŸç”»åƒã‚’æ¨¡æ“¬
        return np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
    
    def test_pose_detection_success(self, detector, person_image):
        """å§¿å‹¢æ¤œå‡ºæˆåŠŸã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        mock_results = Mock()
        mock_results.pose_landmarks = Mock()
        mock_results.pose_landmarks.landmark = [Mock() for _ in range(33)]  # 33å€‹ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
        detector.pose.process.return_value = mock_results
        
        # Act
        results = detector.detect_pose(person_image)
        
        # Assert
        assert results['pose_detected'] is True
        assert 'landmarks' in results
        assert len(results['landmarks']) == 33
    
    def test_pose_detection_failure(self, detector, person_image):
        """å§¿å‹¢æ¤œå‡ºå¤±æ•—ã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        mock_results = Mock()
        mock_results.pose_landmarks = None
        detector.pose.process.return_value = mock_results
        
        # Act
        results = detector.detect_pose(person_image)
        
        # Assert
        assert results['pose_detected'] is False
        assert results['landmarks'] == []
    
    def test_smartphone_use_detection(self, detector, person_image):
        """ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ä½¿ç”¨æ¤œå‡ºã®ãƒ†ã‚¹ãƒˆ"""
        # Arrange - æ‰‹ãŒé¡”ã®è¿‘ãã«ã‚ã‚‹å§¿å‹¢ã‚’æ¨¡æ“¬
        mock_results = Mock()
        mock_results.pose_landmarks = Mock()
        
        # æ‰‹ãŒé¡”ã®è¿‘ãã«ã‚ã‚‹åº§æ¨™ã‚’è¨­å®š
        landmarks = []
        for i in range(33):
            landmark = Mock()
            if i in [15, 16]:  # å·¦å³ã®æ‰‹é¦–
                landmark.x, landmark.y = 0.4, 0.3  # é¡”ã®è¿‘ã
            else:
                landmark.x, landmark.y = 0.5, 0.5  # ãã®ä»–
            landmarks.append(landmark)
        
        mock_results.pose_landmarks.landmark = landmarks
        detector.pose.process.return_value = mock_results
        
        # Act
        results = detector.detect_smartphone_usage(person_image)
        
        # Assert
        assert results['smartphone_usage_detected'] is True
        assert 'confidence' in results
```

---

## ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè‡ªå‹•åŒ–

### GitHub Actions è¨­å®šä¾‹
```yaml
# .github/workflows/test.yml
name: Test Suite

on: [push, pull_request]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run backend tests
        run: |
          cd backend
          pytest tests/ --cov=src --cov-report=xml --cov-fail-under=80
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run frontend tests
        run: |
          cd frontend
          npm run test:coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Start services
        run: |
          docker-compose up -d
      
      - name: Run E2E tests
        run: |
          cd frontend
          npm run test:e2e
```

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# scripts/run_tests.sh

echo "ğŸ§ª KanshiChan ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ"

# Backend ãƒ†ã‚¹ãƒˆ
echo "ğŸ“ Backend ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
cd backend
python -m pytest tests/ -v --cov=src --cov-report=html --cov-report=term
BACKEND_EXIT_CODE=$?

# Frontend ãƒ†ã‚¹ãƒˆ
echo "ğŸ“ Frontend ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
cd ../frontend
npm run test:coverage
FRONTEND_EXIT_CODE=$?

# AI/ML ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
echo "ğŸ“ AI/ML ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
cd ../backend
python -m pytest tests/performance/ -v -m "performance"
PERFORMANCE_EXIT_CODE=$?

# çµæœã‚µãƒãƒªãƒ¼
echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼"
echo "Backend: $([ $BACKEND_EXIT_CODE -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL")"
echo "Frontend: $([ $FRONTEND_EXIT_CODE -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL")"
echo "Performance: $([ $PERFORMANCE_EXIT_CODE -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL")"

# å…¨ä½“ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰
if [ $BACKEND_EXIT_CODE -eq 0 ] && [ $FRONTEND_EXIT_CODE -eq 0 ] && [ $PERFORMANCE_EXIT_CODE -eq 0 ]; then
    echo "ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼"
    exit 0
else
    echo "ğŸ’¥ ãƒ†ã‚¹ãƒˆå¤±æ•—"
    exit 1
fi
```

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆå“è³ªç®¡ç†

### ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™
```bash
# æœ€ä½ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶
- Line Coverage: 80%
- Branch Coverage: 75%
- Function Coverage: 90%

# é‡è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç›®æ¨™
- æ¤œå‡ºã‚¨ãƒ³ã‚¸ãƒ³: 95%
- API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: 90%
- Core ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯: 90%
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆåŸºæº–
```bash
# å®Ÿè¡Œæ™‚é–“åŸºæº–
- å˜ä½“ãƒ†ã‚¹ãƒˆ: å„ãƒ†ã‚¹ãƒˆ <100ms
- çµåˆãƒ†ã‚¹ãƒˆ: å„ãƒ†ã‚¹ãƒˆ <5ç§’
- E2Eãƒ†ã‚¹ãƒˆ: å„ã‚·ãƒŠãƒªã‚ª <30ç§’

# AI/ML ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–
- æ¤œå‡ºå‡¦ç†: >15 FPS
- ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿: <5ç§’
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: <2GB
```

---

## ğŸ“ ãƒ†ã‚¹ãƒˆå ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```markdown
# ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå ±å‘Š

## ğŸ“‹ æ¦‚è¦
- **å®Ÿè¡Œæ—¥æ™‚**: [æ—¥æ™‚]
- **å®Ÿè¡Œè€…**: [å®Ÿè¡Œè€…å]
- **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: [ãƒ–ãƒ©ãƒ³ãƒå]
- **ãƒ†ã‚¹ãƒˆç¨®åˆ¥**: [å˜ä½“/çµåˆ/E2E/æ€§èƒ½/å…¨ä½“]

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ
### Backend (Python/pytest)
- **å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°**: [æˆåŠŸæ•°]/[ç·æ•°]
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: [%]
- **å®Ÿè¡Œæ™‚é–“**: [ç§’]
- **å¤±æ•—ãƒ†ã‚¹ãƒˆ**: [å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆå]

### Frontend (React/Jest)
- **å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°**: [æˆåŠŸæ•°]/[ç·æ•°]
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: [%]
- **å®Ÿè¡Œæ™‚é–“**: [ç§’]
- **å¤±æ•—ãƒ†ã‚¹ãƒˆ**: [å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆå]

### AI/MLæ€§èƒ½ãƒ†ã‚¹ãƒˆ
- **FPS**: [å€¤]
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: [MB]
- **GPUåˆ©ç”¨ç‡**: [%]
- **å‡¦ç†æ™‚é–“**: [ms/frame]

## âš ï¸ æ¤œå‡ºäº‹é …
### å¤±æ•—ãƒ†ã‚¹ãƒˆ
1. [ãƒ†ã‚¹ãƒˆå] - [å¤±æ•—ç†ç”±]
2. [ãƒ†ã‚¹ãƒˆå] - [å¤±æ•—ç†ç”±]

### æ€§èƒ½å•é¡Œ
- [å•é¡Œã®è©³ç´°]

### ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³
- [ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å]: [ç¾åœ¨ã®ã‚«ãƒãƒ¬ãƒƒã‚¸%] (ç›®æ¨™: [ç›®æ¨™%])

## ğŸ”§ å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- [ ] [ä¿®æ­£ã™ã¹ãé …ç›®1]
- [ ] [ä¿®æ­£ã™ã¹ãé …ç›®2]
- [ ] [è¿½åŠ ã™ã¹ããƒ†ã‚¹ãƒˆ]

## ğŸ“ˆ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹æ¨ç§»
- [å‰å›ã¨ã®æ¯”è¼ƒ]
- [æ”¹å–„/æ‚ªåŒ–ã®å‚¾å‘]
```

---

## ğŸš€ ç¶™ç¶šçš„æ”¹å–„

### ãƒ†ã‚¹ãƒˆæˆ¦ç•¥è¦‹ç›´ã—
- **æœˆæ¬¡**: ãƒ†ã‚¹ãƒˆçµæœåˆ†æã¨ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š
- **å››åŠæœŸ**: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™è¦‹ç›´ã—
- **åŠå¹´**: ãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“ã®è©•ä¾¡

### æ–°æŠ€è¡“å°å…¥æ¤œè¨
- **Property-based testing** (Hypothesis/fast-check)
- **Mutation testing** (mutmut/Stryker)
- **Visual regression testing** (Chromatic)
- **Performance monitoring** (Lighthouse CI)

ã“ã®ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã€KanshiChanãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å“è³ªã¨ä¿¡é ¼æ€§ã‚’ç¢ºä¿ã—ã¦ã„ãã¾ã™ã€‚
