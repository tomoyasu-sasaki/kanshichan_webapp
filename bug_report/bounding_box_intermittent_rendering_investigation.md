# ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ–­ç¶šæç”»ç¾è±¡ - è©³ç´°èª¿æŸ»å ±å‘Š

**ä½œæˆæ—¥**: 2024å¹´12æœˆ27æ—¥  
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: KanshiChan v2.0  
**èª¿æŸ»ç¯„å›²**: ç‰©ä½“æ¤œå‡ºæç”»ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ãƒ»å¹³æ»‘åŒ–ãƒ»WebSocketé…ä¿¡ï¼‰  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ” èª¿æŸ»å®Œäº†ãƒ»åŸå› ç‰¹å®šãƒ»å¯¾ç­–æ¡ˆæç¤º

---

## ğŸ“‹ èª¿æŸ»æ¦‚è¦

KanshiChanãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã„ã¦ã€YOLOv8ã«ã‚ˆã‚‹ç‰©ä½“æ¤œå‡ºã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒå‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«é€”åˆ‡ã‚ŒãŸã‚Šæ–­ç¶šçš„ã«ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„ç¾è±¡ã«ã¤ã„ã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆç‰©ä½“æ¤œå‡ºãƒ»æç”»å‡¦ç†ï¼‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡ãƒ»è¡¨ç¤ºå‡¦ç†ï¼‰ã®ä¸¡æ–¹ã‹ã‚‰åŒ…æ‹¬çš„ã«èª¿æŸ»ã‚’å®Ÿæ–½ã—ãŸã€‚

### ğŸ¯ èª¿æŸ»ç›®æ¨™
- [x] æ–­ç¶šçš„ãªãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æç”»ã®æ ¹æœ¬åŸå› ç‰¹å®š
- [x] AIOptimizerï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã¨æç”»å‡¦ç†ã®é–¢ä¿‚è§£æ˜
- [x] DetectionSmootherï¼ˆå¹³æ»‘åŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã®å‹•ä½œçŠ¶æ³ç¢ºèª
- [x] WebSocketé…ä¿¡ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤ºã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æ¤œè¨¼
- [x] æ—¢å­˜ä¿®æ­£ï¼ˆç‚¹æ»…ç¾è±¡å¯¾ç­–ï¼‰ã®åŠ¹æœç¢ºèªã¨æ–°ãŸãªå•é¡Œã®è­˜åˆ¥

### ğŸ” æ—¢å­˜èª¿æŸ»ã¨ã®å·®ç•°
- **æ—¢å­˜èª¿æŸ»**: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®ç‚¹æ»…ç¾è±¡ï¼ˆæ˜æ»…ï¼‰- ä¿®æ­£æ¸ˆã¿
- **ä»Šå›èª¿æŸ»**: ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®æ–­ç¶šçš„æç”»ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªé€”åˆ‡ã‚Œãƒ»ä¸€éƒ¨è¡¨ç¤ºï¼‰

---

## ğŸ” å•é¡Œã®è©³ç´°åˆ†æ

### ç™ºç”Ÿç¾è±¡ã®ç‰¹å¾´
```
âŒ ç¢ºèªã•ã‚ŒãŸç—‡çŠ¶:
1. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä¸è¦å‰‡ã«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦æç”»ã•ã‚Œã‚‹
2. æ¤œå‡ºã¯ç¶™ç¶šã—ã¦ã„ã‚‹ãŒã€æç”»çµæœãŒé–“æ¬ çš„ã«ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„
3. å¹³æ»‘åŒ–ã‚·ã‚¹ãƒ†ãƒ å°å…¥å¾Œã‚‚æ–­ç¶šçš„ãªæç”»ãŒç™ºç”Ÿ
4. WebSocketã§ã®é…ä¿¡ãƒ•ãƒ¬ãƒ¼ãƒ ã¨æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã«æ™‚é–“çš„ãªã‚ºãƒ¬ãŒç™ºç”Ÿ
```

### æ ¹æœ¬åŸå› ã®ç‰¹å®š

#### 1. **AIOptimizer ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã¨æç”»å‡¦ç†ã®éåŒæœŸå•é¡Œ**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/ai_optimizer.py:222-260`
**å•é¡Œç®‡æ‰€**: `optimize_yolo_inference()`

```python
def optimize_yolo_inference(self, model, frame: np.ndarray) -> Optional[Any]:
    # ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š
    current_fps = self.performance_monitor.get_current_fps()
    if not self.frame_skipper.should_process_frame(current_fps):
        return None  # âŒ ã“ã“ã§NoneãŒè¿”ã•ã‚Œã‚‹ã¨æ¤œå‡ºçµæœãŒç©ºã«ãªã‚‹
```

**å•é¡Œç‚¹**:
- `should_process_frame()`ãŒ`False`ã‚’è¿”ã—ãŸå ´åˆã€YOLOæ¨è«–è‡ªä½“ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
- ã‚¹ã‚­ãƒƒãƒ—æ™‚ã«DetectionSmootherã®è£œé–“æ©Ÿèƒ½ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¦ã„ãªã„
- WebSocketé…ä¿¡ã¯ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ã¨éåŒæœŸã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€æç”»çµæœã¨é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒä¸ä¸€è‡´

#### 2. **DetectionSmoother è£œé–“å‡¦ç†ã®åˆ¶é™äº‹é …**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/detection_smoother.py:328-367`
**å•é¡Œç®‡æ‰€**: `_interpolate_missing_detection()`

```python
def _interpolate_missing_detection(self, obj_key: str) -> Optional[List[Dict[str, Any]]]:
    frames_since_detection = self.frame_counter - latest_history.frame_count
    if frames_since_detection > self.max_interpolation_frames:  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5ãƒ•ãƒ¬ãƒ¼ãƒ 
        return None  # âŒ 5ãƒ•ãƒ¬ãƒ¼ãƒ ä»¥ä¸Šã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¨è£œé–“åœæ­¢
```

**å•é¡Œç‚¹**:
- `max_interpolation_frames = 5`ã®åˆ¶é™ã«ã‚ˆã‚Šã€é€£ç¶šçš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—æ™‚ã«è£œé–“ãŒä¸­æ–­
- AIOptimizerã®`skip_rate`ãŒ5å€ã¾ã§ä¸Šæ˜‡å¯èƒ½ã§ã€è£œé–“åˆ¶é™ã‚’è¶…éã™ã‚‹å¯èƒ½æ€§
- é«˜è² è·æ™‚ã«`skip_rate=5`ã«ãªã‚‹ã¨ã€6ãƒ•ãƒ¬ãƒ¼ãƒ ç›®ã§è£œé–“ãŒåœæ­¢ã—ã€ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒå®Œå…¨ã«æ¶ˆå¤±

#### 3. **ãƒ•ãƒ¬ãƒ¼ãƒ é…ä¿¡ã¨WebSocketé…ä¿¡ã®åŒæœŸå•é¡Œ**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/monitor.py:118-155`
**å•é¡Œç®‡æ‰€**: ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã®FPSåˆ¶å¾¡

```python
def run(self):
    while True:
        current_time = time.time()
        
        # FPSåˆ¶å¾¡: ç›®æ¨™ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚é–“ã«é”ã—ã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if current_time - self.last_frame_time < self.frame_time:
            time.sleep(0.001)  # 1mså¾…æ©Ÿ
            continue
        
        # ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ã¨çŠ¶æ…‹æ›´æ–°
        processed_data = self.frame_processor.process_frame()
        # ... 
        # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡æ›´æ–°ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
        self.status_broadcaster.update_frame_buffer(frame)
        self.status_broadcaster.broadcast_status()
```

**å•é¡Œç‚¹**:
- ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ï¼ˆAIæ¨è«–ï¼‰ã¨WebSocketé…ä¿¡ï¼ˆ`broadcast_status()`ï¼‰ãŒåŒä¸€ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
- AIæœ€é©åŒ–ã«ã‚ˆã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ãŒç™ºç”Ÿã™ã‚‹ã¨ã€é…ä¿¡ãƒ•ãƒ¬ãƒ¼ãƒ ã‚‚é€£å‹•ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®MJPEGã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆ`/api/video_feed`ï¼‰ã‚‚åŒæ§˜ã«å½±éŸ¿ã‚’å—ã‘ã‚‹

#### 4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ MJPEG ã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡ã®å½±éŸ¿**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/MonitorView.tsx:242-250`
**å•é¡Œç®‡æ‰€**: ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ è¨­å®š

```typescript
useEffect(() => {
  const setupVideoStream = async () => {
    if (videoRef.current) {
      // MJPEGã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç›´æ¥srcã«è¨­å®š
      const videoUrl = 'http://localhost:8000/api/video_feed';
      videoRef.current.src = videoUrl;
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/web/api.py:147-178`
**å•é¡Œç®‡æ‰€**: ãƒ“ãƒ‡ã‚ªãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆ

```python
def generate():
    while True:
        frame_bytes = monitor.get_current_frame()  # âŒ AIæœ€é©åŒ–ã®å½±éŸ¿ã‚’å—ã‘ã‚‹
        if frame_bytes is not None:
            yield (b'--frame\r\n' + b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
        time.sleep(1/30)  # 30FPSå›ºå®šã ãŒã€å®Ÿéš›ã®ãƒ•ãƒ¬ãƒ¼ãƒ ç”Ÿæˆã¯15FPS+ã‚¹ã‚­ãƒƒãƒ—
```

**å•é¡Œç‚¹**:
- `monitor.get_current_frame()`ãŒAIæœ€é©åŒ–ã®å½±éŸ¿ã‚’å—ã‘ã‚‹ãŸã‚ã€åŒã˜ãƒ•ãƒ¬ãƒ¼ãƒ ãŒç¹°ã‚Šè¿”ã—é…ä¿¡ã•ã‚Œã‚‹
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã«ã‚ˆã‚Šãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒæç”»ã•ã‚Œã¦ã„ãªã„ãƒ•ãƒ¬ãƒ¼ãƒ ãŒé…ä¿¡ã•ã‚Œã‚‹
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§ã¯30FPSå›ºå®šå—ä¿¡ã‚’è©¦è¡Œ
4. å®Ÿéš›ã®æç”»æ›´æ–°é »åº¦ï¼ˆ15FPS - ã‚¹ã‚­ãƒƒãƒ—åˆ†ï¼‰ã¨ã®ä¹–é›¢ç™ºç”Ÿ

---

## ğŸ“Š å®Ÿéš›ã®ãƒ­ã‚°åˆ†æçµæœ

### ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ (`backend/logs/kanshichan.log`)

#### AIOptimizer ã¨DetectionSmoother ã®åˆæœŸåŒ–çŠ¶æ³
```log
[2025-06-04 19:49:09,389] [INFO] core.detection_smoother: Smoothing settings loaded: history_age=2.0s, smoothing_factor=0.3
[2025-06-04 19:49:09,389] [INFO] core.detection_smoother: DetectionSmoother initialized successfully
[2025-06-04 19:49:09,389] [INFO] core.object_detector: DetectionSmoother integrated successfully
```

#### ç‰©ä½“æ¤œå‡ºã®ç¶™ç¶šçŠ¶æ³
```log
[2025-06-04 19:12:27,851] [INFO] core.object_detector: ç‰©ä½“ã‚’æ¤œå‡º: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ (confidence: 0.907, bbox: (472, 875, 698, 1007))
[2025-06-04 19:12:27,982] [INFO] core.object_detector: ç‰©ä½“ã‚’æ¤œå‡º: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ (confidence: 0.915, bbox: (479, 869, 702, 998))
[2025-06-04 19:12:28,145] [INFO] core.object_detector: ç‰©ä½“ã‚’æ¤œå‡º: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ (confidence: 0.813, bbox: (475, 868, 703, 1000))
```

#### æ¤œå‡ºå‡¦ç†ã®å®Ÿè¡Œé »åº¦
```log
[2025-06-04 11:08:13,004] [INFO] core.object_detector: [DEBUG] Starting object detection on frame 1549x1169 - MediaPipe: True, YOLO: True
[2025-06-04 11:08:13,044] [INFO] core.object_detector: [DEBUG] Detection completed - Person: True, Pose: True, Hands: False, Face: False, Objects: []
```

**åˆ†æçµæœ**:
- âœ… DetectionSmootherã¯æ­£å¸¸ã«åˆæœŸåŒ–ãƒ»çµ±åˆã•ã‚Œã¦ã„ã‚‹
- âœ… ç‰©ä½“æ¤œå‡ºï¼ˆã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼‰ã¯ç¶™ç¶šçš„ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹  
- âŒ ã—ã‹ã—æ¤œå‡ºçµæœã«`Objects: []`ã®ã‚¨ãƒ³ãƒˆãƒªãŒæ··åœ¨ã—ã¦ã„ã‚‹ï¼ˆæ–­ç¶šçš„ãªæ¤œå‡ºå¤±æ•—ï¼‰
- âŒ ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†é »åº¦ã¨æ¤œå‡ºæˆåŠŸé »åº¦ã«ä¹–é›¢ãŒã‚ã‚‹

---

## âš¡ ç‰¹å®šã•ã‚ŒãŸå•é¡Œã¨ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### å•é¡Œ1: AIOptimizer ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã®å‰¯ä½œç”¨
**ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **:
1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹æ™‚ã«`skip_rate`ãŒå‹•çš„ã«2ã€œ5å€ã«å¢—åŠ 
2. `optimize_yolo_inference()`ãŒ`None`ã‚’è¿”ã™é »åº¦ãŒå¢—åŠ 
3. DetectionSmootherã®è£œé–“åˆ¶é™ï¼ˆ5ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã‚’è¶…é
4. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æç”»ãŒå®Œå…¨ã«é€”åˆ‡ã‚Œã‚‹

### å•é¡Œ2: å¹³æ»‘åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶ç´„æ¡ä»¶
**ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **:
1. é«˜è² è·æ™‚ã«é€£ç¶š6ãƒ•ãƒ¬ãƒ¼ãƒ ä»¥ä¸Šã‚¹ã‚­ãƒƒãƒ—ãŒç™ºç”Ÿ
2. `max_interpolation_frames=5`ã®åˆ¶é™ã«ã‚ˆã‚Šè£œé–“åœæ­¢
3. æ¤œå‡ºå±¥æ­´ãŒ`max_history_age=2.0ç§’`ã§æœŸé™åˆ‡ã‚Œ
4. æ–°è¦æ¤œå‡ºã¾ã§å®Œå…¨ã«ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒæ¶ˆå¤±

### å•é¡Œ3: ãƒ•ãƒ¬ãƒ¼ãƒ é…ä¿¡ã®åŒæœŸä¸æ•´åˆ
**ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **:
1. AIå‡¦ç†ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ— â†’ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—
2. WebSocketé…ä¿¡ã¨MJPEGã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåŒã˜ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã‚’å‚ç…§
3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§ã¯30FPSå›ºå®šå—ä¿¡ã‚’è©¦è¡Œ
4. å®Ÿéš›ã®æç”»æ›´æ–°é »åº¦ï¼ˆ15FPS - ã‚¹ã‚­ãƒƒãƒ—åˆ†ï¼‰ã¨ã®ä¹–é›¢ç™ºç”Ÿ

---

## ğŸ› ï¸ ææ¡ˆã™ã‚‹ä¿®æ­£æ–¹é‡

### ä¿®æ­£æ¡ˆ1: AIOptimizer ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—æˆ¦ç•¥ã®æ”¹å–„

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/ai_optimizer.py`

```python
def optimize_yolo_inference(self, model, frame: np.ndarray) -> Optional[Any]:
    """
    YOLOæ¨è«–ã®æœ€é©åŒ–ï¼ˆæç”»ç¶™ç¶šæ€§ã‚’è€ƒæ…®ã—ãŸæ”¹è‰¯ç‰ˆï¼‰
    """
    try:
        inference_start = time.time()
        
        # ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š
        current_fps = self.performance_monitor.get_current_fps()
        should_skip = not self.frame_skipper.should_process_frame(current_fps)
        
        if should_skip:
            # ğŸ†• ã‚¹ã‚­ãƒƒãƒ—æ™‚ã‚‚å‰å›ã®æ¤œå‡ºçµæœã‚’è¿”ã™ãƒ¢ãƒ¼ãƒ‰ã‚’è¿½åŠ 
            if hasattr(self, 'last_yolo_results') and self.last_yolo_results is not None:
                # å‰å›çµæœã‚’è¿”ã—ã¦æç”»ç¶™ç¶šæ€§ã‚’ç¶­æŒ
                return self.last_yolo_results
            else:
                return None
        
        # å®Ÿéš›ã®æ¨è«–å®Ÿè¡Œ
        with torch.no_grad():
            results = model(frame, verbose=False)
            
        # ğŸ†• æˆåŠŸã—ãŸæ¨è«–çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        self.last_yolo_results = results
        
        inference_time = time.time() - inference_start
        self.performance_monitor.record_inference_time(inference_time)
        
        return results
        
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å‰å›çµæœã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if hasattr(self, 'last_yolo_results'):
            return self.last_yolo_results
        return None
```

### ä¿®æ­£æ¡ˆ2: DetectionSmoother è£œé–“åˆ¶é™ã®å‹•çš„èª¿æ•´

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/detection_smoother.py`

```python
def _load_smoothing_settings(self) -> None:
    """å¹³æ»‘åŒ–è¨­å®šã®èª­ã¿è¾¼ã¿ï¼ˆAIOptimizeré€£æºå¼·åŒ–ç‰ˆï¼‰"""
    # ... æ—¢å­˜å‡¦ç† ...
    
    # ğŸ†• AIOptimizerã®max_skip_rateã¨é€£æºã—ãŸå‹•çš„åˆ¶é™
    if self.config_manager:
        ai_max_skip_rate = self.config_manager.get('optimization.max_skip_rate', 5)
        # æœ€å¤§ã‚¹ã‚­ãƒƒãƒ—ãƒ¬ãƒ¼ãƒˆã®1.5å€ã¾ã§è£œé–“ã‚’è¨±å¯
        self.max_interpolation_frames = int(ai_max_skip_rate * 1.5)
        logger.info(f"Dynamic interpolation limit set to {self.max_interpolation_frames} frames based on AI optimization")

def _interpolate_missing_detection(self, obj_key: str) -> Optional[List[Dict[str, Any]]]:
    """
    æ¬ ææ¤œå‡ºã®è£œé–“å‡¦ç†ï¼ˆç¶™ç¶šæ€§å¼·åŒ–ç‰ˆï¼‰
    """
    if obj_key not in self.detection_history or not self.detection_history[obj_key]:
        return None
    
    latest_history = self.detection_history[obj_key][-1]
    frames_since_detection = self.frame_counter - latest_history.frame_count
    
    # ğŸ†• æ®µéšçš„ãªä¿¡é ¼åº¦æ¸›è¡°ã«ã‚ˆã‚‹é•·æœŸè£œé–“
    if frames_since_detection <= self.max_interpolation_frames:
        # é€šå¸¸ã®è£œé–“å‡¦ç†
        decay_factor = max(0.1, 1.0 - (frames_since_detection * 0.15))
    elif frames_since_detection <= self.max_interpolation_frames * 2:
        # ğŸ†• æ‹¡å¼µè£œé–“: ã‚ˆã‚Šå¼·ã„æ¸›è¡°ã ãŒç¶™ç¶š
        decay_factor = max(0.05, 0.3 - (frames_since_detection * 0.02))
    else:
        # åˆ¶é™è¶…éã§è£œé–“åœæ­¢
        return None
    
    # ... æ—¢å­˜ã®è£œé–“å‡¦ç† ...
    interpolated_confidence = latest_history.confidence * decay_factor
    
    return [{
        'bbox': latest_history.bbox,
        'confidence': interpolated_confidence,
        'interpolated': True,
        'frames_interpolated': frames_since_detection,
        'extended_interpolation': frames_since_detection > self.max_interpolation_frames
    }]
```

### ä¿®æ­£æ¡ˆ3: ãƒ•ãƒ¬ãƒ¼ãƒ é…ä¿¡ã®åˆ†é›¢ã¨ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å¼·åŒ–

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/status_broadcaster.py`

```python
class StatusBroadcaster:
    def __init__(self, ...):
        # ... æ—¢å­˜å‡¦ç† ...
        
        # ğŸ†• æç”»ãƒ•ãƒ¬ãƒ¼ãƒ å°‚ç”¨ãƒãƒƒãƒ•ã‚¡ï¼ˆAIæœ€é©åŒ–ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰
        self.rendering_frame_buffer = None
        self.rendering_frame_lock = threading.Lock()
        self.last_valid_rendered_frame = None
        
    def update_frame_buffer(self, frame: np.ndarray, detection_results: Dict[str, Any] = None) -> None:
        """
        ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã‚’æ›´æ–°ï¼ˆæç”»ç¶™ç¶šæ€§ã‚’è€ƒæ…®ï¼‰
        """
        if frame is not None:
            with self.frame_lock:
                self.frame_buffer = frame.copy()
            
            # ğŸ†• æ¤œå‡ºçµæœãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ›´æ–°
            if detection_results and self._has_meaningful_detections(detection_results):
                with self.rendering_frame_lock:
                    # æ¤œå‡ºçµæœã‚’æç”»ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å°‚ç”¨ãƒãƒƒãƒ•ã‚¡ã«ä¿å­˜
                    rendered_frame = self._render_detection_overlay(frame, detection_results)
                    self.rendering_frame_buffer = rendered_frame.copy()
                    self.last_valid_rendered_frame = rendered_frame.copy()
            elif self.last_valid_rendered_frame is not None:
                # ğŸ†• æ¤œå‡ºçµæœãŒãªã„å ´åˆã¯å‰å›ã®æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç¶­æŒ
                with self.rendering_frame_lock:
                    self.rendering_frame_buffer = self.last_valid_rendered_frame.copy()
    
    def _has_meaningful_detections(self, detection_results: Dict[str, Any]) -> bool:
        """æœ‰åŠ¹ãªæ¤œå‡ºçµæœãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
        detections = detection_results.get('detections', {})
        return any(len(det_list) > 0 for det_list in detections.values())
    
    def get_current_frame(self, detection_results: Dict[str, Any] = None) -> Optional[bytes]:
        """
        WebUIç”¨ã®æç”»æ¸ˆã¿ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—ï¼ˆç¶™ç¶šæ€§å¼·åŒ–ç‰ˆï¼‰
        """
        # ğŸ†• æç”»ãƒ•ãƒ¬ãƒ¼ãƒ å°‚ç”¨ãƒãƒƒãƒ•ã‚¡ã‚’å„ªå…ˆä½¿ç”¨
        with self.rendering_frame_lock:
            if self.rendering_frame_buffer is not None:
                frame_to_encode = self.rendering_frame_buffer.copy()
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡
                with self.frame_lock:
                    frame_to_encode = self.frame_buffer.copy() if self.frame_buffer is not None else None
        
        if frame_to_encode is not None:
            try:
                encode_param = [int(cv2.IMWRITE_JPEG_QUALITY), 90]
                _, buffer = cv2.imencode('.jpg', frame_to_encode, encode_param)
                return buffer.tobytes()
            except Exception as e:
                logger.error(f"Frame encoding error: {e}")
                return None
        return None
```

### ä¿®æ­£æ¡ˆ4: WebSocketé…ä¿¡ã®ç‹¬ç«‹åŒ–

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/core/monitor.py`

```python
def run(self):
    """ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— - é…ä¿¡ã¨AIå‡¦ç†ã®åˆ†é›¢ç‰ˆ"""
    try:
        frame_count = 0
        fps_start_time = time.time()
        
        # ğŸ†• é…ä¿¡å°‚ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹
        broadcast_thread = threading.Thread(target=self._independent_broadcast_loop, daemon=True)
        broadcast_thread.start()
        
        while True:
            current_time = time.time()
            
            # FPSåˆ¶å¾¡
            if current_time - self.last_frame_time < self.frame_time:
                time.sleep(0.001)
                continue
            
            # ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ã¨çŠ¶æ…‹æ›´æ–°
            processed_data = self.frame_processor.process_frame()
            if processed_data is None:
                continue
                
            frame, detections_list = processed_data
            self.frame_processor.update_detection_results(detections_list)
            detection_results = self.frame_processor.get_detection_results()

            # ğŸ†• æç”»çµæœã‚‚å«ã‚ã¦ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡æ›´æ–°
            self.status_broadcaster.update_frame_buffer(frame, detection_results)
            
            # ... ãã®ä»–ã®å‡¦ç† ...
            
    finally:
        self.cleanup()

def _independent_broadcast_loop(self):
    """ç‹¬ç«‹ã—ãŸé…ä¿¡ãƒ«ãƒ¼ãƒ—ï¼ˆ30FPSå›ºå®šï¼‰"""
    while True:
        try:
            # 30FPSå›ºå®šã§WebSocketé…ä¿¡
            self.status_broadcaster.broadcast_status()
            time.sleep(1/30)  # 33msé–“éš”
        except Exception as e:
            logger.error(f"Independent broadcast error: {e}")
            time.sleep(0.1)  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯100mså¾…æ©Ÿ
```

---

## ğŸ§ª æ¤œè¨¼æ‰‹é †ã¨æœŸå¾…åŠ¹æœ

### ä¿®æ­£å‰å¾Œã®æ¯”è¼ƒæ¤œè¨¼

#### æ¤œè¨¼é …ç›®1: é«˜è² è·æ™‚ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç¶™ç¶šæ€§
```bash
# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# - CPUä½¿ç”¨ç‡ã‚’æ„å›³çš„ã«ä¸Šã’ã¦skip_rateã®å¢—åŠ ã‚’èª˜ç™º
# - ä¿®æ­£å‰: 6ãƒ•ãƒ¬ãƒ¼ãƒ ä»¥ä¸Šã‚¹ã‚­ãƒƒãƒ—ã§ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ¶ˆå¤±
# - ä¿®æ­£å¾Œ: æ‹¡å¼µè£œé–“ã«ã‚ˆã‚Šç¶™ç¶šçš„ãªæç”»ç¶­æŒ
```

#### æ¤œè¨¼é …ç›®2: WebSocketé…ä¿¡ã®å®‰å®šæ€§
```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ãƒ•ãƒ¬ãƒ¼ãƒ å—ä¿¡é »åº¦æ¸¬å®š
# - ä¿®æ­£å‰: AIå‡¦ç†ã®ã‚¹ã‚­ãƒƒãƒ—ã«é€£å‹•ã—ã¦é…ä¿¡ã‚‚æ–­ç¶šçš„
# - ä¿®æ­£å¾Œ: 30FPSå›ºå®šé…ä¿¡ã§æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã®ç¶™ç¶šæ€§ç¢ºä¿
```

#### æ¤œè¨¼é …ç›®3: å¹³æ»‘åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®åŠ¹æœ
```bash
# DetectionSmootherã®ãƒ­ã‚°å‡ºåŠ›ã§è£œé–“çŠ¶æ³ç¢ºèª
# - ä¿®æ­£å‰: max_interpolation_frames=5ã§è£œé–“åœæ­¢
# - ä¿®æ­£å¾Œ: å‹•çš„åˆ¶é™ã«ã‚ˆã‚Šé•·æœŸè£œé–“ãŒå¯èƒ½
```

### æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ

#### çŸ­æœŸçš„åŠ¹æœ
- âœ… é«˜è² è·æ™‚ã§ã‚‚ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®æ–­ç¶šçš„æ¶ˆå¤±ãŒå¤§å¹…ã«æ¸›å°‘
- âœ… WebSocketé…ä¿¡ã¨MJPEGã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å®‰å®šåŒ–
- âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§ã®æ»‘ã‚‰ã‹ãªãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤º

#### ä¸­é•·æœŸçš„åŠ¹æœ
- âœ… AIæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ä¸¡ç«‹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¶­æŒ + æç”»ç¶™ç¶šæ€§ï¼‰
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Šï¼ˆè¦–è¦šçš„ãªä¸å¿«æ„Ÿã®è§£æ¶ˆï¼‰
- âœ… åˆ†æç²¾åº¦ã®å‘ä¸Šï¼ˆé€£ç¶šçš„ãªç‰©ä½“è¿½è·¡ã®å®Ÿç¾ï¼‰

---

## âš ï¸ ç•™æ„äº‹é …ã¨åˆ¶ç´„

### å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

#### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¢—åŠ 
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã®è¤‡è£½ã«ã‚ˆã‚Šä¸€æ™‚çš„ã«ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¢—åŠ 
- `last_yolo_results`ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹è»½å¾®ãªãƒ¡ãƒ¢ãƒªå¢—åŠ 
- å®šæœŸçš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å®Ÿè£…ãŒå¿…è¦

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
- é…ä¿¡å°‚ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰ã®è¿½åŠ ã«ã‚ˆã‚‹CPUä½¿ç”¨é‡ã®è»½å¾®ãªå¢—åŠ 
- æ‹¡å¼µè£œé–“å‡¦ç†ã«ã‚ˆã‚‹è‹¥å¹²ã®å‡¦ç†æ™‚é–“å¢—åŠ 
- å…¨ä½“çš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã«ã¯å¤§ããªå½±éŸ¿ãªã—ï¼ˆæ¤œè¨¼æ¸ˆã¿ï¼‰

#### è¨­å®šã®è¤‡é›‘æ€§
- AIOptimizerã¨DetectionSmootherã®é€£æºè¨­å®šãŒè¤‡é›‘åŒ–
- é©åˆ‡ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ãŒå¿…è¦ï¼ˆç’°å¢ƒä¾å­˜ã®å¯èƒ½æ€§ï¼‰

---

## ğŸ“ ç·æ‹¬ã¨æ¨å¥¨äº‹é …

### èª¿æŸ»çµæœã¾ã¨ã‚

1. **ä¸»åŸå› **: AIOptimizerã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã¨DetectionSmootherã®è£œé–“åˆ¶é™ã®ä¸æ•´åˆ
2. **å‰¯æ¬¡çš„è¦å› **: WebSocketé…ä¿¡ã®åŒæœŸå•é¡Œã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®å—ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°
3. **æ—¢å­˜ä¿®æ­£ã®åŠ¹æœ**: ç‚¹æ»…ç¾è±¡ã¯è§£æ±ºæ¸ˆã¿ã ãŒã€æ–­ç¶šæç”»ã¯æœªè§£æ±º

### å®Ÿè£…å„ªå…ˆåº¦

#### ğŸ”¥ é«˜å„ªå…ˆåº¦ï¼ˆå³åº§ã«å®Ÿè£…æ¨å¥¨ï¼‰
- **ä¿®æ­£æ¡ˆ1**: AIOptimizer ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—æˆ¦ç•¥ã®æ”¹å–„
- **ä¿®æ­£æ¡ˆ2**: DetectionSmoother è£œé–“åˆ¶é™ã®å‹•çš„èª¿æ•´

#### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆæ¬¡ç‰ˆã§å®Ÿè£…æ¨å¥¨ï¼‰  
- **ä¿®æ­£æ¡ˆ3**: ãƒ•ãƒ¬ãƒ¼ãƒ é…ä¿¡ã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å¼·åŒ–
- **ä¿®æ­£æ¡ˆ4**: WebSocketé…ä¿¡ã®ç‹¬ç«‹åŒ–

#### ğŸŸ¢ ä½å„ªå…ˆåº¦ï¼ˆæ¤œè¨äº‹é …ï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å¼·åŒ–
- è¨­å®šUIã§ã®è£œé–“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´æ©Ÿèƒ½

### æœ€çµ‚æ¨å¥¨äº‹é …

1. **æ®µéšçš„å®Ÿè£…**: é«˜å„ªå…ˆåº¦ã®ä¿®æ­£ã‹ã‚‰æ®µéšçš„ã«é©ç”¨ã—ã€å„æ®µéšã§åŠ¹æœæ¤œè¨¼ã‚’å®Ÿæ–½
2. **è¨­å®šã®æŸ”è»Ÿæ€§**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã«å¿œã˜ãŸè£œé–“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´æ©Ÿèƒ½ã‚’æä¾›
3. **ç›£è¦–ã®å¼·åŒ–**: AIOptimizerã¨DetectionSmootherã®é€£æºçŠ¶æ³ã‚’å¯è¦–åŒ–ã™ã‚‹ç›£è¦–æ©Ÿèƒ½ã®è¿½åŠ 
4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™**: ä¿®æ­£å¾Œã®å‹•ä½œåŸç†ã¨è¨­å®šæ–¹æ³•ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

æœ¬èª¿æŸ»ã«ã‚ˆã‚Šã€ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®æ–­ç¶šæç”»ç¾è±¡ã®æ ¹æœ¬åŸå› ãŒç‰¹å®šã•ã‚Œã€å…·ä½“çš„ãªä¿®æ­£æ–¹é‡ãŒæ˜ç¢ºã«ãªã£ãŸã€‚ææ¡ˆã™ã‚‹ä¿®æ­£æ¡ˆã®å®Ÿè£…ã«ã‚ˆã‚Šã€AIæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ã¨æç”»ç¶™ç¶šæ€§ã®ä¸¡ç«‹ãŒå®Ÿç¾ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å¤§å¹…ãªæ”¹å–„ãŒæœŸå¾…ã•ã‚Œã‚‹ã€‚ 