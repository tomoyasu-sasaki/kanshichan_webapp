= 取得データの分析処理内容調査報告書
:doctype: book
:toc: left
:toclevels: 3
:source-highlighter: highlight.js
:icons: font
:sectnums:
:xrefstyle: short

== 概要

本報告書は、KanshiChan監視システムにおけるフロントエンドが期待する分析結果データの形式と、バックエンドが返す分析結果データの形式について詳細に調査し、両者の差異を分析した結果をまとめたものです。

=== 調査の目的

* フロントエンドが期待する分析結果データの形式と内容の把握
* バックエンドが返す分析結果データの形式と内容の把握  
* 両者の差異の特定と分析
* データ形式の統一性に関する課題の抽出

=== 調査対象

* バックエンドAPI仕様（分析関連エンドポイント）
* フロントエンドTypeScript型定義
* WebSocket通信データ形式
* 実装コードレベルでのデータ処理ロジック

== バックエンド分析結果データ形式

=== API共通レスポンス形式

バックエンドは以下の統一されたレスポンス形式を採用：

[source,json]
----
// 成功時
{
  "status": "success",
  "data": {...},
  "timestamp": "2024-12-27T10:30:00.000Z"
}

// エラー時
{
  "status": "error", 
  "error": "エラーメッセージ",
  "code": "ERROR_CODE",
  "timestamp": "2024-12-27T10:30:00.000Z"
}
----

=== 基本分析API (`/api/analysis/trends`)

==== リクエスト

[source,http]
----
GET /api/analysis/trends?timeframe=daily&user_id=optional
----

==== レスポンス形式

[source,json]
----
{
  "status": "success",
  "data": {
    "timeframe": "daily",
    "period_start": "2024-12-26T10:30:00.000Z",
    "period_end": "2024-12-27T10:30:00.000Z", 
    "total_logs": 150,
    "focus_analysis": {
      "basic_statistics": {
        "mean": 0.65,
        "median": 0.70,
        "std_dev": 0.15,
        "min": 0.20,
        "max": 0.95
      },
      "trend_analysis": {
        "direction": "up",
        "strength": 0.75,
        "slope": 0.012,
        "trend_percentage": 12.5
      },
      "focus_patterns": {
        "peak_times": ["09:00-11:00", "14:00-16:00"],
        "low_times": ["12:00-13:00"],
        "pattern_strength": 0.8
      },
      "hourly_patterns": {
        "hour_averages": {...},
        "productivity_peaks": [...]
      }
    },
    "anomalies": [
      {
        "type": "posture_anomaly",
        "severity": "medium",
        "timestamp": "2024-12-27T08:30:00.000Z",
        "description": "長時間同一姿勢検出"
      }
    ],
    "trend_summary": {
      "overall_trend": "improving",
      "key_metrics": {...}
    }
  },
  "timestamp": "2024-12-27T10:30:00.000Z"
}
----

=== 高度分析API (`/api/analysis/advanced-patterns`)

==== レスポンス形式

[source,json]
----
{
  "status": "success",
  "data": {
    "timeframe": "week",
    "pattern_type": "behavioral_patterns",
    "period_start": "2024-12-20T00:00:00.000Z",
    "period_end": "2024-12-27T00:00:00.000Z",
    "total_logs": 1050,
    "timeseries_analysis": {
      "trend_strength": 0.8,
      "trend_direction": "up",
      "seasonal_patterns": ["morning_peak", "afternoon_dip"],
      "anomalies_count": 3,
      "data_quality_score": 0.95
    },
    "pattern_recognition": {
      "behavioral_patterns": [
        {
          "pattern_type": "focus_cycle",
          "confidence": 0.85,
          "frequency": 3.2,
          "description": "90分集中サイクル",
          "recommendations": ["25分集中、5分休憩を推奨"]
        }
      ]
    },
    "clustering_analysis": {
      "clusters": [
        {
          "cluster_id": 1,
          "characteristics": "高集中状態",
          "data_points": 320,
          "centroid": {...}
        }
      ]
    },
    "insights": [
      "午前中の集中度が持続的に向上",
      "スマートフォン使用による中断が減少傾向"
    ]
  },
  "timestamp": "2024-12-27T10:30:00.000Z"
}
----

=== 予測分析API (`/api/analysis/predictions`)

==== レスポンス形式

[source,json]
----
{
  "status": "success", 
  "data": {
    "prediction_horizon_hours": 24,
    "predictions": [
      {
        "metric": "focus_score",
        "current_value": 0.72,
        "predicted_value": 0.78,
        "confidence": 0.85,
        "trend": "increasing",
        "prediction_horizon_hours": 24,
        "factors_influencing": ["持続的な集中改善", "環境条件良好"],
        "recommendations": ["現在のペースを維持", "2時間毎の休憩推奨"]
      }
    ],
    "trend_analysis": [
      {
        "period": "1週間",
        "trend_strength": 0.7,
        "trend_direction": "up",
        "seasonal_patterns": ["午前中ピーク"],
        "anomalies_detected": 1
      }
    ],
    "future_scenarios": [
      {
        "scenario_name": "最適環境継続",
        "probability": 0.75,
        "expected_outcomes": {
          "focus_score": 0.85,
          "productivity_score": 0.80,
          "health_score": 0.90
        },
        "key_factors": ["環境維持", "規則的休憩"],
        "preventive_actions": ["定期的な姿勢チェック"]
      }
    ]
  },
  "timestamp": "2024-12-27T10:30:00.000Z"
}
----

=== リアルタイム分析API (`/api/analysis/realtime-stream`)

==== POST リクエスト

[source,json]
----
{
  "user_id": "user123",
  "data": {
    "eye_movement": {
      "gaze_direction": {"x": 0.5, "y": 0.3},
      "blink_rate": 15,
      "focus_intensity": 0.8
    },
    "pose_data": {
      "head_pose": {"pitch": 5, "yaw": -2, "roll": 1},
      "shoulder_alignment": 0.9,
      "posture_score": 0.85
    },
    "environment": {
      "lighting_level": 0.7,
      "noise_level": 0.2,
      "screen_brightness": 0.6
    }
  },
  "timestamp": "2024-12-27T10:30:00.000Z"
}
----

==== レスポンス

[source,json]
----
{
  "status": "success",
  "data": {
    "processing_result": "accepted",
    "realtime_analysis": {
      "current_focus_score": 0.82,
      "attention_state": "focused",
      "posture_assessment": "good",
      "break_recommendation": false,
      "anomaly_detected": false
    },
    "updated_metrics": {
      "session_average_focus": 0.75,
      "time_in_session": 3600,
      "alerts_triggered": 0
    }
  },
  "timestamp": "2024-12-27T10:30:00.000Z"
}
----

=== WebSocket リアルタイムデータ

==== status_update イベント

[source,json]
----
{
  "personDetected": true,
  "smartphoneDetected": false,
  "absenceTime": 0,
  "smartphoneUseTime": 45.5,
  "absenceAlert": false,
  "smartphoneAlert": false
}
----

==== behavior_data イベント（拡張）

[source,json]
----
{
  "focus_trends": [
    {
      "timestamp": "2024-12-27T10:30:00.000Z",
      "focus_score": 0.82,
      "posture_score": 0.90,
      "productivity_score": 0.75
    }
  ],
  "current_status": {
    "presence_status": "present",
    "smartphone_detected": false,
    "focus_level": 0.82,
    "posture_score": 0.90
  },
  "session_stats": {
    "total_logs": 150,
    "present_time_ratio": 0.95,
    "smartphone_usage_ratio": 0.05
  }
}
----

==== analysis_results イベント

[source,json]
----
[
  "集中度が過去1時間で15%向上しました",
  "姿勢が改善傾向にあります",
  "スマートフォン使用時間が目標値以下です"
]
----

== フロントエンド期待データ形式

=== TypeScript型定義

==== 基本検出状態

[source,typescript]
----
interface DetectionStatus {
  personDetected: boolean;
  smartphoneDetected: boolean;
  absenceTime: number;
  smartphoneUseTime: number;
  absenceAlert?: boolean;
  smartphoneAlert?: boolean;
}
----

==== 分析データ

[source,typescript]
----
interface AnalyticsData {
  timestamp: string;
  focus_score: number;
  posture_score: number;
  productivity_score: number;
  fatigue_level: number;
  distraction_count: number;
}
----

==== 行動パターン

[source,typescript]
----
interface BehaviorPattern {
  pattern_type: string;
  confidence: number;
  frequency: number;
  description: string;
  recommendations: string[];
}
----

==== 予測インサイト

[source,typescript]
----
interface PredictiveInsight {
  metric: string;
  predicted_value: number;
  confidence: number;
  timestamp: string;
  trend: 'increasing' | 'decreasing' | 'stable';
}
----

==== パフォーマンスメトリクス

[source,typescript]
----
interface PerformanceMetric {
  name: string;
  current_value: number;
  target_value: number;
  status: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';
}
----

=== フロントエンド実装での期待値

==== AdvancedAnalyticsDashboard.tsx

[source,typescript]
----
// 期待するAPIエンドポイント
const timeseriesResponse = await fetch(
  `${API_BASE_URL}/analysis/trends?timeframe=${selectedTimeframe}&user_id=${userId}`
);

const patternsResponse = await fetch(
  `${API_BASE_URL}/analysis/advanced-patterns?user_id=${userId}&timeframe=${selectedTimeframe}`
);

const predictionsResponse = await fetch(
  `${API_BASE_URL}/analysis/predictions?user_id=${userId}&metrics=focus_score,productivity_score,fatigue_level`
);

// 期待するデータ構造
setAnalyticsData(timeseriesData.trends?.focus_trends || []);
setBehaviorPatterns(patternsData.patterns?.behavior_patterns || []);
setPredictiveInsights(predictionsData.predictions || []);
----

==== BehaviorInsights.tsx

[source,typescript]
----
// 期待する行動トレンドデータ
interface BehaviorTrend {
  timeframe: string;
  period_start?: string;
  period_end?: string;
  total_logs: number;
  focus_analysis?: {
    average_focus?: number;
    trend_direction?: 'up' | 'down' | 'stable';
    trend_percentage?: number;
    good_posture_percentage?: number;
    presence_rate?: number;
    smartphone_usage_rate?: number;
    total_sessions?: number;
  };
  anomalies?: unknown[];
  trend_summary?: unknown;
}

// 期待する日次インサイト
interface DailyInsight {
  target_date: string;
  logs_analyzed?: number;
  insights?: {
    focus_score?: number;
    productivity_score?: number;
    key_findings?: string[];
    improvement_areas?: string[];
  };
  summary?: {
    summary?: string;
  };
}
----

== 両者の差異分析

=== 1. データ構造の違い

==== 成功時のラッピング

[cols="1,1,1"]
|===
|項目|バックエンド|フロントエンド期待

|レスポンス構造
|`{status: "success", data: {...}, timestamp: "..."}`
|直接データアクセス: `response.data`

|エラーハンドリング
|`{status: "error", error: "...", code: "..."}`
|HTTPステータスコードベース

|タイムスタンプ
|レスポンスレベルで提供
|データ項目内で期待
|===

==== データアクセスパターン

[source,typescript]
----
// バックエンド実際
{
  "status": "success",
  "data": {
    "focus_analysis": {
      "basic_statistics": {...}
    }
  }
}

// フロントエンド期待
timeseriesData.trends?.focus_trends  // data.focus_trends を直接期待
patternsData.patterns?.behavior_patterns  // data.behavior_patterns を直接期待
----

=== 2. フィールド名の不一致

[cols="1,1,1"]
|===
|データ項目|バックエンド|フロントエンド期待

|集中度トレンド
|`focus_analysis.trend_analysis`
|`trends.focus_trends`

|行動パターン
|`pattern_recognition.behavioral_patterns`
|`patterns.behavior_patterns`

|予測データ
|`predictions[]`
|`predictions[]` (一致)

|パフォーマンス
|`system_statistics`, `analysis_statistics`
|`system_statistics`, `analysis_statistics` (一致)
|===

=== 3. 型の不一致

==== 集中度データ

[cols="1,1,1"]
|===
|項目|バックエンド|フロントエンド期待

|focus_score
|`focus_analysis.basic_statistics.mean` (0.0-1.0)
|`focus_score` (number)

|trend_direction
|`focus_analysis.trend_analysis.direction` ("up"/"down"/"stable")
|`trend_direction` ('up'/'down'/'stable')

|confidence
|`pattern_recognition.behavioral_patterns[].confidence`
|`confidence` (number)
|===

==== 時間データ

[cols="1,1,1"]
|===
|項目|バックエンド|フロントエンド期待

|期間指定
|`period_start`, `period_end` (ISO string)
|`period_start?`, `period_end?` (optional)

|タイムスタンプ
|`timestamp` (ISO string)
|`timestamp` (string)
|===

=== 4. WebSocketデータの整合性

==== DetectionStatus

✅ **一致している項目**
[source,typescript]
----
interface DetectionStatus {
  personDetected: boolean;        // ✅ 一致
  smartphoneDetected: boolean;    // ✅ 一致
  absenceTime: number;           // ✅ 一致
  smartphoneUseTime: number;     // ✅ 一致
  absenceAlert?: boolean;        // ✅ 一致
  smartphoneAlert?: boolean;     // ✅ 一致
}
----

==== 拡張データ（behavior_data, analysis_results）

❌ **不一致・未定義**

[source,typescript]
----
// バックエンドが送信（monitor.py）
enhanced_status = {
  'behavior_data': behavior_data,
  'detection_data': current_detection_results,
  'analysis_results': self._generate_quick_insights(recent_logs)
}

// フロントエンドには対応する型定義が不在
// AdvancedAnalyticsDashboard.tsx で any型で受信
socket.on('behavior_data', (data: any) => {...});
socket.on('analysis_results', (data: any) => {...});
----

== 問題点と課題

=== 1. 重大な問題

==== データアクセスパターンの不整合

❌ **問題**: フロントエンドがネストしたデータ構造を期待しているが、バックエンドは統一レスポンス形式でラップしている

[source,typescript]
----
// 現状：動作しない可能性が高い
setAnalyticsData(timeseriesData.trends?.focus_trends || []);

// 正しくは
setAnalyticsData(timeseriesData.data?.focus_analysis?.basic_statistics || []);
----

==== フィールド名の不一致

❌ **問題**: 多くのフィールド名が一致していない

[source,text]
----
期待: trends.focus_trends
実際: data.focus_analysis

期待: patterns.behavior_patterns  
実際: data.pattern_recognition.behavioral_patterns
----

=== 2. 中程度の問題

==== 型安全性の欠如

⚠️ **問題**: WebSocketで送信される拡張データに型定義がない

[source,typescript]
----
// any型で処理されている
socket.on('behavior_data', (data: any) => {...});
socket.on('analysis_results', (data: any) => {...});
----

==== データ変換の不在

⚠️ **問題**: フロントエンドでバックエンドデータ形式への変換処理が不足

=== 3. 軽微な問題

==== オプショナルフィールドの不一致

ℹ️ **問題**: 一部フィールドのオプショナル性が不一致

== 解決策の提案

=== 1. 短期対応（即座に実装可能）

==== フロントエンドでのデータ変換関数

[source,typescript]
----
// transformPerformanceData 関数の拡張例
const transformAnalyticsData = (backendData: BackendAnalyticsResponse): AnalyticsData[] => {
  return backendData.data?.focus_analysis?.basic_statistics?.map(stat => ({
    timestamp: stat.timestamp,
    focus_score: stat.mean,
    posture_score: stat.posture_score || 0.5,
    productivity_score: stat.productivity || 0.5,
    fatigue_level: 1.0 - stat.mean, // 疲労度は集中度の逆
    distraction_count: stat.distraction_events || 0
  })) || [];
};

// 使用例
const processedData = transformAnalyticsData(timeseriesData);
setAnalyticsData(processedData);
----

==== TypeScript型定義の追加

[source,typescript]
----
// WebSocket拡張データ用の型定義
interface BehaviorDataUpdate {
  focus_trends: AnalyticsData[];
  current_status: {
    presence_status: string;
    smartphone_detected: boolean;
    focus_level: number;
    posture_score: number;
  };
  session_stats: {
    total_logs: number;
    present_time_ratio: number;
    smartphone_usage_ratio: number;
  };
}

interface AnalysisResultsUpdate {
  insights: string[];
  timestamp: string;
}
----

=== 2. 中期対応（APIレスポンス統一）

==== バックエンドAPI形式の調整

オプション1: レスポンス形式の選択的変更
[source,python]
----
# 分析APIのみフラット形式で返す
@basic_analysis_bp.route('/trends', methods=['GET'])
def get_behavior_trends():
    # ... 処理 ...
    return jsonify(trend_data)  # dataキーでラップしない
----

オプション2: 互換性レイヤーの追加
[source,python]
----
def format_for_frontend(data: Dict[str, Any], api_type: str) -> Dict[str, Any]:
    """フロントエンド向けにデータ形式を調整"""
    if api_type == 'trends':
        return {
            'trends': {
                'focus_trends': data.get('focus_analysis', {})
            }
        }
    # ... 他の形式 ...
----

=== 3. 長期対応（統一仕様策定）

==== 統一データスキーマの策定

[source,yaml]
----
# api_schema.yaml
analytics_response:
  type: object
  properties:
    metadata:
      type: object
      properties:
        timeframe: string
        period_start: string (ISO 8601)
        period_end: string (ISO 8601)
        total_logs: integer
    analytics_data:
      type: array
      items:
        type: object
        properties:
          timestamp: string
          focus_score: number
          posture_score: number
          productivity_score: number
    patterns:
      type: array
      items:
        type: object
        properties:
          pattern_type: string
          confidence: number
          description: string
----

== 推奨実装順序

=== Phase 1: 緊急対応（1-2日）

1. ✅ フロントエンドにデータ変換関数を追加
2. ✅ TypeScript型定義を追加
3. ✅ エラーハンドリングを強化

=== Phase 2: 安定化（1週間）

1. 🔶 バックエンドAPI形式の部分調整
2. 🔶 WebSocketデータ形式の統一
3. 🔶 テストケースの追加

=== Phase 3: 最適化（2-3週間）

1. 🔷 統一データスキーマの策定
2. 🔷 APIドキュメントの更新
3. 🔷 型定義の完全統一

== 結論

フロントエンドとバックエンドの分析データ形式には以下の重要な差異が存在します：

1. **データ構造の不一致**: バックエンドの統一レスポンス形式とフロントエンドの期待値の齟齬
2. **フィールド名の不一致**: 多くの重要フィールドで命名が異なる
3. **型安全性の欠如**: WebSocket拡張データに適切な型定義がない

これらの問題は段階的な対応により解決可能であり、短期的にはフロントエンドでの変換関数により対処し、中長期的にはAPI仕様の統一により根本解決を図ることを推奨します。

---
*本報告書作成日: 2024-12-27*  
*調査対象コード: backend/src/, frontend/src/*  
*規約準拠: project_rules/* 