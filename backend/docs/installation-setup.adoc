= 🚀 監視ちゃん(KanshiChan) インストール・セットアップガイド
:toc: left
:toc-title: 目次
:toclevels: 4
:numbered:
:source-highlighter: highlight.js
:icons: font
:doctype: book
:version: 1.0.0
:author: KanshiChan Development Team
:email: team@kanshichan.dev
:revnumber: 1.0
:revdate: {docdate}
:experimental:

== 📖 概要

監視ちゃん（KanshiChan）バックエンドシステムの包括的なインストール・セットアップガイドです。
開発環境から本番環境まで、段階的なセットアップ手順とベストプラクティスを提供します。

[NOTE]
====
📋 **ドキュメント情報**

* **対象読者**: インフラエンジニア、運用エンジニア、DevOpsエンジニア
* **前提知識**: Linux操作、Docker/Docker Compose、Python基礎
* **セットアップ時間**: 開発環境 30分、本番環境 2-3時間
* **サポート対象OS**: Ubuntu 20.04+, CentOS 8+, macOS 12+
* **最終更新**: {docdate}

**関連ドキュメント**: <<configuration-guide>>, <<backend-architecture>>, <<operations-monitoring>>
====

== 🎯 システム要件

=== 💻 ハードウェア要件

==== 最小要件（開発環境）
[cols="2,2,2", options="header"]
|===
|項目 |最小要件 |推奨要件
|**CPU** |2コア 2.4GHz |4コア 3.0GHz以上
|**メモリ** |4GB RAM |8GB RAM以上
|**ストレージ** |20GB 空き容量 |50GB SSD
|**GPU** |なし（CPU推論） |NVIDIA GPU (CUDA対応)
|===

==== 本番環境要件
[cols="2,2,2", options="header"]
|===
|項目 |最小要件 |推奨要件
|**CPU** |4コア 3.0GHz |8コア 3.5GHz以上
|**メモリ** |8GB RAM |16GB RAM以上
|**ストレージ** |100GB SSD |500GB NVMe SSD
|**GPU** |NVIDIA GPU (6GB VRAM) |NVIDIA RTX 4070以上
|**ネットワーク** |1Gbps |10Gbps
|===

=== 🖥️ ソフトウェア要件

==== 必須ソフトウェア
[cols="2,2,3", options="header"]
|===
|ソフトウェア |バージョン |備考
|**Python** |3.11.x |3.12.x対応予定
|**Docker** |20.10+ |Container実行環境
|**Docker Compose** |2.0+ |オーケストレーション
|**Git** |2.30+ |ソースコード管理
|**Redis** |7.0+ |キャッシュ・セッション管理
|===

==== AI/ML関連依存ライブラリ
[cols="2,2,3", options="header"]
|===
|ライブラリ |バージョン |用途
|**PyTorch** |2.5.1 |深層学習フレームワーク
|**Ultralytics** |8.3.87 |YOLO実装
|**MediaPipe** |0.10.21 |姿勢推定
|**OpenCV** |4.11.x |画像処理
|**NumPy** |1.24.x |数値計算
|===

== 🔧 環境別セットアップ

=== 💻 開発環境セットアップ

==== 1. リポジトリクローン
```bash
# プロジェクトクローン
git clone https://github.com/kanshichan/kanshichan.git
cd kanshichan/backend

# ブランチ確認（mainブランチ推奨）
git branch -a
git checkout main
```

==== 2. Python環境構築
```bash
# Python仮想環境作成
python3.11 -m venv venv
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate  # Windows

# パッケージ管理ツール更新
pip install --upgrade pip setuptools wheel

# 依存関係インストール
pip install -r requirements.txt
```

==== 3. Docker Compose セットアップ
```bash
# Docker Compose で Redis 起動
docker-compose -f docker-compose.dev.yml up -d redis

# サービス状態確認
docker-compose -f docker-compose.dev.yml ps
```

==== 4. 設定ファイル準備
```bash
# 環境設定ファイル作成
cp config/config.example.yaml config/config.yaml

# 開発環境用設定を適用
cp config/env/.env.development .env
```

==== 5. 初期化・動作確認
```bash
# データベース初期化（該当する場合）
python -m src.scripts.init_db

# 開発サーバー起動
python -m src.app
```

==== 開発環境構成図
[mermaid]
....
graph TB
    subgraph "🖥️ 開発マシン"
        DEV[開発者PC<br/>Ubuntu/macOS/Windows]
        PYTHON[Python 3.11<br/>仮想環境]
        GIT[Git Repository<br/>ローカル]
    end
    
    subgraph "🐳 Docker環境"
        REDIS[Redis 7.0<br/>キャッシュサーバー]
        VOLUMES[Docker Volumes<br/>データ永続化]
    end
    
    subgraph "🔧 開発ツール"
        IDE[IDE/エディタ<br/>VS Code/PyCharm]
        DEBUG[デバッガー<br/>pdb/IPython]
        LINT[リンター<br/>black/flake8/mypy]
    end
    
    DEV --> PYTHON
    PYTHON --> GIT
    DEV --> REDIS
    REDIS --> VOLUMES
    DEV --> IDE
    IDE --> DEBUG
    IDE --> LINT
    
    classDef dev fill:#e3f2fd
    classDef docker fill:#f3e5f5
    classDef tools fill:#e8f5e8
    
    class DEV,PYTHON,GIT dev
    class REDIS,VOLUMES docker
    class IDE,DEBUG,LINT tools
....

=== 🏭 本番環境セットアップ

==== システム構成概要
[mermaid]
....
graph TB
    subgraph "🌐 Load Balancer"
        LB[Nginx<br/>ロードバランサー]
        SSL[SSL Termination<br/>証明書管理]
    end
    
    subgraph "🚀 Application Layer"
        APP1[KanshiChan App<br/>Instance 1]
        APP2[KanshiChan App<br/>Instance 2]
        APP3[KanshiChan App<br/>Instance N...]
    end
    
    subgraph "💾 Data Layer"
        REDIS[Redis Cluster<br/>キャッシュ・セッション]
        FS[File System<br/>ログ・一時ファイル]
    end
    
    subgraph "📊 Monitoring"
        METRICS[Prometheus<br/>メトリクス収集]
        LOGS[Fluentd<br/>ログ集約]
        ALERTS[Grafana<br/>監視・アラート]
    end
    
    subgraph "🔒 Security"
        FIREWALL[Firewall<br/>ネットワーク制御]
        AUTH[認証システム<br/>JWT/OAuth]
    end
    
    LB --> SSL
    SSL --> APP1
    SSL --> APP2
    SSL --> APP3
    
    APP1 --> REDIS
    APP2 --> REDIS
    APP3 --> REDIS
    
    APP1 --> FS
    APP2 --> FS
    APP3 --> FS
    
    APP1 --> METRICS
    APP2 --> METRICS
    APP3 --> METRICS
    
    APP1 --> LOGS
    APP2 --> LOGS
    APP3 --> LOGS
    
    METRICS --> ALERTS
    LOGS --> ALERTS
    
    FIREWALL --> LB
    AUTH --> APP1
    AUTH --> APP2
    AUTH --> APP3
    
    classDef lb fill:#e3f2fd
    classDef app fill:#f3e5f5
    classDef data fill:#e8f5e8
    classDef monitor fill:#fff3e0
    classDef security fill:#fce4ec
    
    class LB,SSL lb
    class APP1,APP2,APP3 app
    class REDIS,FS data
    class METRICS,LOGS,ALERTS monitor
    class FIREWALL,AUTH security
....

==== 1. システム環境準備
```bash
# システム更新
sudo apt update && sudo apt upgrade -y

# 必須パッケージインストール
sudo apt install -y \
    curl wget git vim \
    build-essential \
    python3.11 python3.11-venv python3.11-dev \
    nginx redis-server \
    htop iotop nethogs

# Docker インストール
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Docker Compose インストール
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

==== 2. アプリケーション デプロイ
```bash
# プロダクション用ディレクトリ作成
sudo mkdir -p /opt/kanshichan
sudo chown $USER:$USER /opt/kanshichan
cd /opt/kanshichan

# ソースコード取得
git clone https://github.com/kanshichan/kanshichan.git .
git checkout v2.0.0  # 安定版タグ

# Python環境構築
python3.11 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r backend/requirements.txt
```

==== 3. 設定ファイル構成
```bash
# 本番環境設定コピー
cp backend/config/env/.env.production backend/.env
cp backend/config/config.production.yaml backend/config/config.yaml

# 機密情報設定（環境変数で管理）
export REDIS_PASSWORD="your_secure_redis_password"
export JWT_SECRET_KEY="your_jwt_secret_key"
export API_SECRET_KEY="your_api_secret_key"

# 設定ファイル検証
python -m backend.src.scripts.validate_config
```

==== 4. Redis クラスター構築
```bash
# Redis設定ファイル作成
sudo tee /etc/redis/redis.conf << EOF
# Redis 本番環境設定
bind 127.0.0.1
port 6379
requirepass ${REDIS_PASSWORD}
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
EOF

# Redis サービス起動・自動起動設定
sudo systemctl start redis-server
sudo systemctl enable redis-server
sudo systemctl status redis-server
```

==== 5. Nginx リバースプロキシ設定
```bash
# Nginx設定ファイル作成
sudo tee /etc/nginx/sites-available/kanshichan << EOF
server {
    listen 80;
    server_name your-domain.com;
    
    # SSL リダイレクト
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL設定
    ssl_certificate /etc/ssl/certs/kanshichan.crt;
    ssl_certificate_key /etc/ssl/private/kanshichan.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    # セキュリティヘッダー
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    
    # プロキシ設定
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # WebSocket対応
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 静的ファイル
    location /static/ {
        alias /opt/kanshichan/backend/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ヘルスチェック
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
EOF

# 設定有効化
sudo ln -s /etc/nginx/sites-available/kanshichan /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

==== 6. Systemd サービス設定
```bash
# systemd サービスファイル作成
sudo tee /etc/systemd/system/kanshichan.service << EOF
[Unit]
Description=KanshiChan Backend Service
After=network.target redis-server.service
Requires=redis-server.service

[Service]
Type=simple
User=kanshichan
Group=kanshichan
WorkingDirectory=/opt/kanshichan/backend
Environment=PATH=/opt/kanshichan/venv/bin
EnvironmentFile=/opt/kanshichan/backend/.env
ExecStart=/opt/kanshichan/venv/bin/python -m src.app
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=kanshichan

# セキュリティ設定
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/kanshichan/backend/logs
ReadWritePaths=/opt/kanshichan/backend/tmp

[Install]
WantedBy=multi-user.target
EOF

# サービス有効化・起動
sudo systemctl daemon-reload
sudo systemctl enable kanshichan
sudo systemctl start kanshichan
sudo systemctl status kanshichan
```

=== 🐳 Docker セットアップ（推奨）

==== Docker Compose 本番構成
```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  kanshichan-app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    restart: unless-stopped
    environment:
      - ENVIRONMENT=production
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config:ro
    depends_on:
      - redis
    networks:
      - kanshichan-network
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - kanshichan-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - kanshichan-app
    networks:
      - kanshichan-network

volumes:
  redis-data:
    driver: local

networks:
  kanshichan-network:
    driver: bridge
```

==== Docker デプロイコマンド
```bash
# 環境変数設定
export REDIS_PASSWORD="your_secure_password"
export JWT_SECRET="your_jwt_secret"

# コンテナビルド・起動
docker-compose -f docker-compose.prod.yml build
docker-compose -f docker-compose.prod.yml up -d

# デプロイ確認
docker-compose -f docker-compose.prod.yml ps
docker-compose -f docker-compose.prod.yml logs -f kanshichan-app
```

== 🔧 設定・調整

=== ⚙️ 基本設定

==== config.yaml 主要設定項目
```yaml
# 基本設定
app:
  name: "KanshiChan"
  version: "2.0.0"
  debug: false
  host: "0.0.0.0"
  port: 8000

# AI/ML設定
ai:
  yolo:
    model_path: "yolov8n.pt"
    confidence_threshold: 0.5
    iou_threshold: 0.7
    max_detections: 10
    device: "auto"  # auto/cpu/cuda/mps
    
  mediapipe:
    enabled: true
    model_complexity: 0
    min_detection_confidence: 0.7
    min_tracking_confidence: 0.7
    
  optimization:
    frame_skip_enabled: true
    max_skip_rate: 5
    target_fps: 15.0
    cache_enabled: true
    batch_processing: false

# Redis設定
redis:
  host: "localhost"
  port: 6379
  password: "${REDIS_PASSWORD}"
  db: 0
  max_connections: 100
  socket_timeout: 5.0

# ログ設定
logging:
  level: "INFO"
  format: "json"
  file_path: "logs/kanshichan.log"
  max_file_size: "100MB"
  backup_count: 5
  
# セキュリティ設定
security:
  jwt_secret_key: "${JWT_SECRET_KEY}"
  jwt_expiration_hours: 24
  api_rate_limit: 100  # requests per minute
  cors_origins: ["https://your-domain.com"]
```

=== 🚀 パフォーマンス最適化

==== GPU設定確認
```bash
# NVIDIA GPU 確認
nvidia-smi

# CUDA インストール確認
python -c "import torch; print(f'CUDA Available: {torch.cuda.is_available()}')"
python -c "import torch; print(f'CUDA Version: {torch.version.cuda}')"

# Apple Silicon MPS 確認（macOS）
python -c "import torch; print(f'MPS Available: {torch.backends.mps.is_available()}')"
```

==== メモリ・CPU最適化
```bash
# システムリソース確認
free -h
nproc
cat /proc/cpuinfo | grep "cpu cores"

# Python設定（.bashrc に追加）
export OMP_NUM_THREADS=4
export MKL_NUM_THREADS=4
export NUMEXPR_NUM_THREADS=4
```

==== Redis 最適化設定
```bash
# Redis メモリ最適化
redis-cli CONFIG SET maxmemory 2gb
redis-cli CONFIG SET maxmemory-policy allkeys-lru

# Redis パフォーマンス確認
redis-cli INFO memory
redis-cli INFO stats
```

== ✅ 動作確認・検証

=== 🔍 基本動作確認

==== ヘルスチェック
```bash
# サービス稼働確認
curl -X GET http://localhost:8000/health
# Expected: {"status": "healthy", "timestamp": "..."}

# AI/ML機能確認
curl -X GET http://localhost:8000/api/v1/detection/status
# Expected: {"yolo": "ready", "mediapipe": "ready"}

# Redis接続確認
curl -X GET http://localhost:8000/api/v1/cache/status
# Expected: {"redis": "connected", "keys": 0}
```

==== 機能別テスト
```bash
# YOLO推論テスト
python -m src.scripts.test_yolo

# MediaPipe テスト
python -m src.scripts.test_mediapipe

# WebSocket接続テスト
python -m src.scripts.test_websocket

# パフォーマンステスト
python -m src.scripts.benchmark
```

=== 📊 パフォーマンス検証

==== システムメトリクス監視
```bash
# CPU・メモリ使用率監視
htop

# GPU使用率監視（NVIDIA）
watch -n 1 nvidia-smi

# ネットワーク監視
nethogs

# ディスクI/O監視
iotop
```

==== ログ確認
```bash
# アプリケーションログ
tail -f /opt/kanshichan/backend/logs/kanshichan.log

# システムログ
sudo journalctl -u kanshichan -f

# Nginx ログ
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

=== 🚨 トラブルシューティング

==== よくある問題と対処法
[cols="2,3,2", options="header"]
|===
|問題 |原因・対処法 |確認コマンド
|**起動失敗** |設定ファイル・依存関係問題 |`journalctl -u kanshichan`
|**YOLO エラー** |モデルファイル・GPU設定問題 |`python -m src.scripts.test_yolo`
|**Redis 接続失敗** |Redis未起動・パスワード設定 |`redis-cli ping`
|**メモリ不足** |バッチサイズ・キャッシュサイズ過大 |`free -h`, `top`
|**高CPU使用率** |フレームスキップ無効・過負荷 |`htop`, 設定調整
|===

==== 緊急時対応
```bash
# サービス再起動
sudo systemctl restart kanshichan
sudo systemctl restart redis-server
sudo systemctl restart nginx

# ログレベル変更（デバッグ）
# config.yaml の logging.level を "DEBUG" に変更
sudo systemctl reload kanshichan

# 緊急停止
sudo systemctl stop kanshichan

# 設定ロールバック
git checkout HEAD~1 backend/config/config.yaml
sudo systemctl restart kanshichan
```

== 📋 運用チェックリスト

=== ✅ セットアップ完了チェック

==== 基本環境
* [ ] Python 3.11 インストール・仮想環境作成
* [ ] 必須パッケージインストール（requirements.txt）
* [ ] Redis サーバー起動・接続確認
* [ ] Git リポジトリクローン・ブランチ確認

==== アプリケーション
* [ ] 設定ファイル作成・編集（config.yaml, .env）
* [ ] AI/MLモデルダウンロード・配置
* [ ] サービス起動・ヘルスチェック成功
* [ ] WebSocket接続・API動作確認

==== セキュリティ
* [ ] ファイアウォール設定
* [ ] SSL証明書設置・有効化
* [ ] パスワード・シークレットキー設定
* [ ] 不要ポート・サービス無効化

==== 監視・ログ
* [ ] ログファイル出力確認
* [ ] ログローテーション設定
* [ ] メトリクス収集設定
* [ ] アラート設定

=== 📅 定期メンテナンス

==== 日次チェック
* [ ] サービス稼働状況確認
* [ ] エラーログ確認
* [ ] リソース使用率確認
* [ ] バックアップ実行状況確認

==== 週次チェック
* [ ] パフォーマンスメトリクス分析
* [ ] ログファイル整理
* [ ] セキュリティパッチ確認
* [ ] ディスク容量確認

==== 月次チェック
* [ ] システム全体バックアップ
* [ ] 設定ファイル見直し
* [ ] 依存パッケージ更新検討
* [ ] 容量・性能計画見直し

== 🔗 関連ドキュメント

=== 📖 必須参照ドキュメント
* **<<configuration-guide>>**: 詳細設定ガイド（設定パラメータ詳細）
* **<<backend-architecture>>**: システムアーキテクチャ（全体構成理解）
* **<<operations-monitoring>>**: 運用・監視（運用手順詳細）
* **<<troubleshooting-guide>>**: トラブルシューティング（問題解決手法）

=== 🛠️ 開発者向けリソース
* **<<development-guide>>**: 開発環境セットアップ（開発者向け詳細）
* **<<rest-api-reference>>**: REST API仕様（API利用方法）
* **<<websocket-api>>**: WebSocket API仕様（リアルタイム通信）
* **<<testing-strategy>>**: テスト戦略（品質保証手法）

=== 📊 技術詳細
* **<<ai-ml-specifications>>**: AI/ML技術仕様（AI機能詳細）
* **<<performance-optimization>>**: パフォーマンス最適化（性能改善）
* **<<security-specifications>>**: セキュリティ仕様（セキュリティ詳細）

[NOTE]
====
🔄 **継続的改善**

このドキュメントは実際のセットアップ経験と運用実績に基づいて
継続的に更新・改善されます。

**フィードバック**: team@kanshichan.dev +
**改善提案**: GitHub Issues での報告推奨
====

---

**📞 Contact**: team@kanshichan.dev +
**🔗 Repository**: https://github.com/kanshichan/backend +
**📅 Last Updated**: {docdate} +
**📝 Document Version**: {revnumber} 